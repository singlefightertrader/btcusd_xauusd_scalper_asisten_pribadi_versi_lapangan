<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SCALPER ASSISTANT · FINAL A++ (FIELD SAFE + HTF INFO)</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>
body{margin:0;background:#000;color:#eafff5;font-family:Consolas,monospace}
#top{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #222;flex-wrap:wrap}
select,button,input{background:#111;color:#fff;border:1px solid #444;padding:6px}
button.ui-active{box-shadow:0 0 8px rgba(0,255,255,.9);border-color:#00ffff}
button.blocked{opacity:.35;pointer-events:none}
#status{font-weight:bold}
#session{margin-left:auto;color:#aaa}
#utc{color:#ffaa00;font-size:12px}
#contextLabel{font-weight:bold}

#tvWrap{position:relative}
#tv{width:100%;height:36vh;border:none}

/* overlay lines */
.line{
 position:absolute;
 left:0; right:0;
 height:1px;
 opacity:.9;
}
.m15{background:#ffff00}
.m30{background:#00bfff}
.h1{background:#bf00ff}

#panel{height:64vh;overflow:auto;padding:8px}
.section{border:1px solid #333;margin-bottom:8px;padding:8px;background:#070707}
.hidden{display:none}
.ok{color:#00ff99}
.warn{color:#ff4444}
.info{color:#ffaa00}
.ctx{white-space:pre-line}
.zone{margin-top:6px;padding:6px;border:1px dashed #00ffff;color:#00ffff}
.small{font-size:12px;color:#aaa}
</style>
</head>

<body>

<div id="top">
  <b>PAIR</b>
  <select id="pair">
    <option>BTCUSDT</option>
    <option>XAUUSD</option>
  </select>
  <b id="status">BOOT</b>
  <span id="contextLabel">CONTEXT NONE</span>
  <span id="session"></span>
  <span id="utc"></span>
  <button id="toggleReason">SHOW</button>
  <button id="resyncBtn">RE-SYNC</button>
</div>

<div id="tvWrap">
  <iframe id="tv"></iframe>
  <div id="lines"></div>
</div>

<div id="panel">

<div class="section">
<b>ANCHOR H1 · MANUAL OHLC</b><br>
O <input id="o" size="7">
H <input id="h" size="7">
L <input id="l" size="7">
C <input id="c" size="7">
<button id="setAnchor">SET</button>
<div id="anchorNote"></div>
</div>

<div class="section">
<b>MISSION / CONTEXT</b>
<div id="missionView" class="ctx"></div>
<div id="strength" class="info"></div>
<div id="priorityTarget" class="info"></div>
<div id="contextFresh" class="ok hidden">CONTEXT FRESH</div>
</div>

<div class="section">
<b>HTF COUNTDOWN</b>
<div id="countdown" class="small"></div>
</div>

<div class="section">
<b>DECISION</b><br>
<button id="buy">BUY</button>
<button id="sell">SELL</button>
<div id="entryZone" class="zone hidden"></div>
<div id="lateWarn" class="warn hidden">RISIKO FLOATING BESAR</div>
<div id="cooldown" class="info hidden">COOLDOWN AKTIF</div>
</div>

<div id="reason" class="section hidden ctx"></div>

</div>

<script>
/* ================= CORE ================= */
const TF=["1m","5m","15m","30m","1h"];
const KEY="SCALPER_FINAL_FIELD_SAFE_PLUS";
let S=JSON.parse(localStorage.getItem(KEY)||"{}");

function init(){
 return{
  price:null,prevPrice:null,
  anchor:null,anchorState:"NONE",
  tf:{},
  contextPrice:null,contextState:"NONE",contextSide:null,
  contextSince:null,
  cooldownUntil:0
 };
}

["BTCUSDT","XAUUSD"].forEach(p=>{
 if(!S[p])S[p]=init();
 TF.forEach(tf=>{
  if(!S[p].tf[tf])S[p].tf[tf]={prev:null,last:null,missions:[]};
 });
});
const save=()=>localStorage.setItem(KEY,JSON.stringify(S));

/* ================= TIME ================= */
const utcNow=()=>new Date().toUTCString();
const getSession=()=>{
 const h=new Date().getUTCHours();
 if(h<7)return"ASIA";
 if(h<13)return"LONDON";
 if(h<21)return"NEW YORK";
 return"OFF";
};

/* ================= ANCHOR ================= */
const MAX=1000*60*60*4;
function updateAnchor(p){
 if(!p.anchor){p.anchorState="NONE";return;}
 const age=Date.now()-p.anchor.t;
 if(p.anchor.bad)p.anchorState="INVALID";
 else if(age>MAX)p.anchorState="EXPIRED";
 else if(age>MAX*0.6)p.anchorState="SUSPECT";
 else p.anchorState="OK";
}

/* ================= MISSIONS ================= */
function createMission(d){
 if(d.prev==null)return;
 if(d.missions.some(m=>m.price===d.prev))return;
 const role=["15m","30m","1h"].includes(d.tf)?"CONTEXT":"TARGET";
 d.missions.push({price:d.prev,role,status:"ACTIVE"});
}
function updateMission(d,close){
 d.missions.forEach(m=>{
  if(m.status==="ACTIVE"){
   if(close===m.price)m.status="CONSUMED";
   else if(m.role==="CONTEXT")m.status="CONTEXT";
   else m.status="WAITING";
  }
 });
}

/* ===== FIX HTF MISS ===== */
function forceHTFMission(p){
 ["15m","30m","1h"].forEach(tf=>{
  const d=p.tf[tf];
  if(d.last && !d.missions.some(m=>m.price===d.last)){
    d.missions.push({price:d.last,role:"CONTEXT",status:"CONTEXT"});
  }
 });
}

/* ================= CONTEXT ================= */
function isContextBreached(p){
 if(p.contextPrice==null||p.prevPrice==null)return false;
 return(
  (p.prevPrice<p.contextPrice&&p.price>p.contextPrice)||
  (p.prevPrice>p.contextPrice&&p.price<p.contextPrice)
 );
}
function updateContext(p){
 let ctx=[];
 ["15m","30m","1h"].forEach(tf=>{
  p.tf[tf].missions.forEach(m=>{
   if(m.role==="CONTEXT"&&m.status==="CONTEXT")ctx.push(m.price);
  });
 });
 if(!ctx.length){p.contextState="NONE";p.contextSide=null;return;}
 ctx.sort((a,b)=>Math.abs(p.price-a)-Math.abs(p.price-b));
 const c=ctx[0];
 if(p.contextPrice!==c){
   p.contextPrice=c;
   p.contextSince=Date.now();
 }
 if(isContextBreached(p))p.contextState="BREACHED";
 else p.contextState="VALID";
 p.contextSide=p.price>=c?"ABOVE":"BELOW";
}

/* ================= ENTRY ZONE ================= */
function getEntryZone(p){
 const m1=p.tf["1m"].missions.find(m=>m.status==="WAITING");
 const m5=p.tf["5m"].missions.find(m=>m.status==="WAITING");
 if(!m1||!m5)return null;
 return{lo:Math.min(m1.price,m5.price),hi:Math.max(m1.price,m5.price)};
}

/* ================= STRENGTH ================= */
function contextStrength(p){
 let s=0;
 ["15m","30m","1h"].forEach(tf=>{
  if(p.tf[tf].missions.some(m=>m.status==="CONTEXT"))s+=25;
 });
 if(p.anchorState==="OK")s+=15;
 if(p.contextState==="BREACHED")s=0;
 if(Date.now()<p.cooldownUntil)s-=20;
 return Math.max(0,Math.min(100,s));
}
const strengthLabel=s=>s>=70?"STRONG":s>=40?"MODERATE":"WEAK";

/* ================= DECISION ================= */
function finalDecisionState(p){
 if(p.anchorState!=="OK")return"WAIT";
 if(p.contextState==="BREACHED")return"WAIT";
 if(Date.now()<p.cooldownUntil)return"WAIT";
 const z=getEntryZone(p);
 if(!z)return"WAIT";
 const mid=(z.lo+z.hi)/2;
 if(p.price>z.lo&&p.price<z.hi)return"GAS";
 if(Math.abs(p.price-mid)<(z.hi-z.lo))return"STANDBY";
 if(p.contextState==="VALID")return"EARLY";
 return"LATE";
}
function validBuy(p,z){return p.contextSide==="ABOVE"&&p.price<=z.hi;}
function validSell(p,z){return p.contextSide==="BELOW"&&p.price>=z.lo;}

/* ================= AUDIO ================= */
const AC=new(window.AudioContext||window.webkitAudioContext)();
function gasSound(){
 let i=0;
 const t=setInterval(()=>{
  const o=AC.createOscillator(),g=AC.createGain();
  o.frequency.value=900;g.gain.value=.08;
  o.connect(g);g.connect(AC.destination);
  o.start();o.stop(AC.currentTime+.12);
  if(++i===4)clearInterval(t);
 },180);
}

/* ================= WS BTC ================= */
let ws;
function connect(){
 ws=new WebSocket("wss://stream.binance.com:9443/stream?streams="+TF.map(t=>"btcusdt@kline_"+t).join("/"));
 ws.onmessage=e=>{
  const k=JSON.parse(e.data).data.k;
  if(!k.x)return;
  const p=S.BTCUSDT,d=p.tf[k.i];
  p.prevPrice=p.price;
  d.tf=k.i;d.prev=d.last;d.last=+k.c;p.price=+k.c;
  createMission(d);
  updateMission(d,+k.c);
  forceHTFMission(p);
  updateAnchor(p);
  updateContext(p);
  save();render();
 };
}
connect();
setInterval(()=>{if(!ws||ws.readyState>1)connect()},5000);

/* ================= XAU LOOP ================= */
setInterval(()=>{
 const p=S.XAUUSD;
 if(!p.anchor)return;
 p.prevPrice=p.price;
 p.price=p.anchor.C;
 TF.forEach(tf=>{
  const d=p.tf[tf];
  d.tf=tf;d.prev=d.last;d.last=p.anchor.C;
  createMission(d);
  updateMission(d,p.anchor.C);
 });
 forceHTFMission(p);
 updateAnchor(p);
 updateContext(p);
 save();render();
},60000);

/* ================= COUNTDOWN ================= */
function tfMs(tf){
 return tf==="15m"?900000:tf==="30m"?1800000:tf==="1h"?3600000:0;
}
function renderCountdown(p){
 let out=[];
 ["15m","30m","1h"].forEach(tf=>{
  const d=p.tf[tf];
  if(!d.last)return;
  const next=tfMs(tf)-((Date.now()-d.last)%tfMs(tf));
  const m=Math.floor(next/60000);
  const s=Math.floor((next%60000)/1000);
  out.push(`${tf.toUpperCase()} close in ${m}:${String(s).padStart(2,"0")}`);
 });
 countdown.textContent=out.join(" | ");
}

/* ================= UI ================= */
const pair=document.getElementById("pair");
const status=document.getElementById("status");
const session=document.getElementById("session");
const utc=document.getElementById("utc");
const contextLabel=document.getElementById("contextLabel");
const missionView=document.getElementById("missionView");
const strengthEl=document.getElementById("strength");
const priorityTarget=document.getElementById("priorityTarget");
const entryZone=document.getElementById("entryZone");
const lateWarn=document.getElementById("lateWarn");
const cooldown=document.getElementById("cooldown");
const anchorNote=document.getElementById("anchorNote");
const buy=document.getElementById("buy");
const sell=document.getElementById("sell");
const toggleReason=document.getElementById("toggleReason");
const reason=document.getElementById("reason");
const resyncBtn=document.getElementById("resyncBtn");
const lines=document.getElementById("lines");
const contextFresh=document.getElementById("contextFresh");
const countdown=document.getElementById("countdown");

function render(){
 const p=S[pair.value];
 session.textContent="SESSION: "+getSession();
 utc.textContent="UTC: "+utcNow();
 updateAnchor(p);updateContext(p);

 const ds=finalDecisionState(p);
 status.textContent=ds;
 buy.textContent="BUY · "+ds;
 sell.textContent="SELL · "+ds;

 contextLabel.textContent=
  p.contextState==="BREACHED"
   ?"STRUCTURE BREAK"
   :"CONTEXT "+(p.contextSide||"NONE");

 const cs=contextStrength(p);
 strengthEl.textContent=`STRENGTH: ${cs}/100 (${strengthLabel(cs)})`;

 contextFresh.classList.toggle(
  "hidden",
  !(p.contextSince && Date.now()-p.contextSince < tfMs("15m"))
 );

 lateWarn.classList.toggle("hidden",ds!=="LATE");
 cooldown.classList.toggle("hidden",Date.now()>=p.cooldownUntil);

 const z=getEntryZone(p);
 if(z&&(ds==="GAS"||ds==="STANDBY")){
  entryZone.textContent=`ENTRY IDEAL: M1–M5 (${z.lo.toFixed(2)} – ${z.hi.toFixed(2)})`;
  entryZone.classList.remove("hidden");
 }else entryZone.classList.add("hidden");

 renderCountdown(p);

 let txt="";
 TF.forEach(tf=>{
  p.tf[tf].missions.slice(-2).forEach(m=>{
   txt+=`${tf} ${m.price.toFixed(2)} ${m.status}\n`;
  });
 });
 missionView.textContent=txt.trim();

 /* ===== VISUAL LINES ===== */
 lines.innerHTML="";
 ["15m","30m","1h"].forEach(tf=>{
  const m=p.tf[tf].missions.find(x=>x.status==="CONTEXT");
  if(!m)return;
  const line=document.createElement("div");
  line.className="line "+(tf==="15m"?"m15":tf==="30m"?"m30":"h1");
  line.style.top="50%"; // visual only (non-price scaled)
  lines.appendChild(line);
 });
}

/* ================= EVENTS ================= */
setAnchor.onclick=()=>{
 setAnchor.classList.add("ui-active");
 const O=+o.value,H=+h.value,L=+l.value,C=+c.value;
 const p=S[pair.value];
 if(H<Math.max(O,C)||L>Math.min(O,C)||O===C)p.anchor={bad:true,t:Date.now()};
 else p.anchor={O,H,L,C,t:Date.now()};
 updateAnchor(p);save();render();
 anchorNote.innerHTML=p.anchorState==="OK"?"✅ ANCHOR OK":"⚠️ ANCHOR "+p.anchorState;
 anchorNote.className=p.anchorState==="OK"?"ok":"warn";
};

buy.onclick=()=>{
 const p=S[pair.value];
 const ds=finalDecisionState(p);
 const z=getEntryZone(p);
 if(ds!=="GAS"||!z||!validBuy(p,z))return;
 buy.classList.add("ui-active");sell.classList.remove("ui-active");
 status.textContent="BUY · GAS (SUPPORT)";
 p.cooldownUntil=Date.now()+60000;
 gasSound();save();render();
};

sell.onclick=()=>{
 const p=S[pair.value];
 const ds=finalDecisionState(p);
 const z=getEntryZone(p);
 if(ds!=="GAS"||!z||!validSell(p,z))return;
 sell.classList.add("ui-active");buy.classList.remove("ui-active");
 status.textContent="SELL · GAS (RESISTANCE)";
 p.cooldownUntil=Date.now()+60000;
 gasSound();save();render();
};

toggleReason.onclick=()=>{
 reason.classList.toggle("hidden");
 toggleReason.classList.toggle("ui-active",!reason.classList.contains("hidden"));
};

resyncBtn.onclick=()=>{
 const p=S[pair.value];
 updateAnchor(p);
 forceHTFMission(p);
 updateContext(p);
 status.textContent="RE-SYNC OK";
 resyncBtn.classList.add("ui-active");
 save();render();
 setTimeout(()=>resyncBtn.classList.remove("ui-active"),1200);
};

function loadChart(){
 tv.src=`https://s.tradingview.com/widgetembed/?symbol=${pair.value==="BTCUSDT"?"BINANCE:BTCUSDT":"OANDA:XAUUSD"}&interval=60&theme=dark&timezone=Etc/UTC`;
}
pair.onchange=()=>{loadChart();render();};
loadChart();render();
</script>

</body>
</html>
