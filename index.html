<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SCALPER ASSISTANT · FINAL A++ (FIELD SAFE 52/52)</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{margin:0;background:#000;color:#eafff5;font-family:Consolas,monospace}
#top{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid #222}
select,button,input{background:#111;color:#fff;border:1px solid #444;padding:6px}
button.ui-active{box-shadow:0 0 8px rgba(0,255,255,.6);border-color:#00ffff}
#status{font-weight:bold}
#session{margin-left:auto;color:#aaa}
#contextLabel{font-weight:bold}
#tv{width:100%;height:36vh;border:none}
#panel{height:64vh;overflow:auto;padding:8px}
.section{border:1px solid #333;margin-bottom:8px;padding:8px;background:#070707}
.hidden{display:none}
.ok{color:#00ff99}
.warn{color:#ff4444}
.info{color:#ffaa00}
.ctx{white-space:pre-line}
.zone{margin-top:6px;padding:6px;border:1px dashed #00ffff;color:#00ffff}
.overlay{position:relative}
.line{position:absolute;left:0;right:0;height:1px}
.m15{background:#ffff00}
.m30{background:#00bfff}
.h1{background:#bf00ff}
</style>
</head>

<body>

<div id="top">
  <b>PAIR</b>
  <select id="pair">
    <option>BTCUSDT</option>
    <option>XAUUSD</option>
  </select>
  <b id="status">BOOT</b>
  <span id="contextLabel">CONTEXT NONE</span>
  <span id="session"></span>
  <button id="toggleReason">SHOW</button>
</div>

<div class="overlay">
  <iframe id="tv"></iframe>
  <div id="lines"></div>
</div>

<div id="panel">

  <div class="section">
    <b>ANCHOR H1 · MANUAL OHLC</b><br>
    O <input id="o" size="7"> 
    H <input id="h" size="7">
    L <input id="l" size="7"> 
    C <input id="c" size="7">
    <button id="setAnchor">SET</button>
    <div id="anchorNote"></div>
  </div>

  <div class="section">
    <b>MISSION / CONTEXT</b>
    <div id="missionView" class="ctx"></div>
    <div id="strength" class="info"></div>
    <div id="priorityTarget" class="info"></div>
  </div>

  <div class="section">
    <b>DECISION</b><br>
    <button id="buy">BUY</button>
    <button id="sell">SELL</button>
    <div id="entryZone" class="zone hidden"></div>
    <div id="tpSuggest" class="info"></div>
    <div id="lateWarn" class="warn hidden">RISIKO FLOATING BESAR</div>
    <div id="cooldown" class="info hidden">COOLDOWN AKTIF</div>
  </div>

  <div id="reason" class="section hidden ctx"></div>
</div>

<script>
/* ================= CORE ================= */
const TF=["1m","5m","15m","30m","1h"];
const KEY="SCALPER_FINAL_A_PP_52";
let S=JSON.parse(localStorage.getItem(KEY)||"{}");

function init(){
  return {
    price:null, prevPrice:null,
    anchor:null, anchorState:"NONE",
    tf:{},
    contextPrice:null, contextState:"NONE", contextFresh:false,
    cooldownUntil:0
  };
}

["BTCUSDT","XAUUSD"].forEach(p=>{
  if(!S[p])S[p]=init();
  TF.forEach(tf=>{
    if(!S[p].tf[tf])S[p].tf[tf]={prev:null,last:null,missions:[]};
  });
});

function save(){localStorage.setItem(KEY,JSON.stringify(S));}

/* ================= SESSION ================= */
function getSession(){
  const h=new Date().getUTCHours();
  if(h>=0&&h<7) return "ASIA";
  if(h>=7&&h<13) return "LONDON";
  if(h>=13&&h<21) return "NEW YORK";
  return "OFF";
}

/* ================= ANCHOR ================= */
const MAX=1000*60*60*4;
function updateAnchor(p){
  if(!p.anchor){p.anchorState="NONE";return;}
  const age=Date.now()-p.anchor.t;
  if(p.anchor.bad)p.anchorState="INVALID";
  else if(age>MAX)p.anchorState="EXPIRED";
  else if(age>MAX*0.6)p.anchorState="SUSPECT";
  else p.anchorState="OK";
}

/* ================= MISSIONS ================= */
function createMission(d){
  if(d.prev==null) return;
  const role=["15m","30m","1h"].includes(d.tf)?"CONTEXT":"TARGET";
  d.missions.push({price:d.prev,role,status:"ACTIVE"});
}
function updateMission(d,close){
  d.missions.forEach(m=>{
    if(m.status==="ACTIVE"){
      if(close===m.price) m.status="CONSUMED";
      else if(m.role==="CONTEXT") m.status="CONTEXT";
      else m.status="WAITING";
    }
  });
}

/* ================= CONTEXT ================= */
function updateContext(p){
  const HTF=["15m","30m","1h"];
  let ctx=[];
  HTF.forEach(tf=>{
    p.tf[tf].missions.forEach(m=>{
      if(m.role==="CONTEXT" && m.status==="CONTEXT") ctx.push(m.price);
    });
  });
  if(!ctx.length){p.contextState="NONE";return;}
  ctx.sort((a,b)=>Math.abs(p.price-a)-Math.abs(p.price-b));
  const nearest=ctx[0];
  if(p.contextPrice!==nearest){
    p.contextPrice=nearest;
    p.contextFresh=true;
    p.contextState="CONTEXT_FRESH";
    return;
  }
  if(
    (p.prevPrice<p.contextPrice && p.price>p.contextPrice) ||
    (p.prevPrice>p.contextPrice && p.price<p.contextPrice)
  ){
    p.contextState="CONTEXT_BREACHED";
    return;
  }
  p.contextState="CONTEXT_VALID";
}

/* ================= CONTEXT STRENGTH ================= */
function contextStrength(p){
  let score=0,agree=0;
  ["15m","30m","1h"].forEach(tf=>{
    p.tf[tf].missions.forEach(m=>{
      if(m.role==="CONTEXT" && m.status==="CONTEXT"){
        agree++; score+=30;
      }
    });
  });
  if(p.anchorState==="OK") score+=10;
  score=Math.min(100,score);
  let cat=score>=70?"STRONG":score>=40?"MODERATE":"WEAK";
  return {score,cat,agree};
}

/* ================= TP SUGGEST ================= */
function tpSuggest(p){
  const s=contextStrength(p);
  if(s.cat==="STRONG") return "TP: HOLD · ikut HTF (M15–H1)";
  if(s.cat==="MODERATE") return "TP: SCALP 1–2 candle (M1–M5)";
  return "TP: cepat / skip trade";
}

/* ================= DECISION ================= */
function inCooldown(p){return Date.now()<p.cooldownUntil;}

function getDecisionState(p){
  if(p.anchorState!=="OK") return "WAIT";
  if(p.contextState==="CONTEXT_BREACHED") return "WAIT";
  if(inCooldown(p)) return "WAIT";
  const m1=p.tf["1m"].missions.filter(m=>m.status!=="CONSUMED");
  const m5=p.tf["5m"].missions.filter(m=>m.status!=="CONSUMED");
  if(!m1.length||!m5.length) return "WAIT";
  const lo=Math.min(m1[0].price,m5[0].price);
  const hi=Math.max(m1[0].price,m5[0].price);
  const mid=(lo+hi)/2;
  if(p.price>lo && p.price<hi) return "GAS";
  if(Math.abs(p.price-mid)<(hi-lo)*1.5) return "STANDBY";
  if(p.contextState==="CONTEXT_FRESH") return "EARLY";
  return "LATE";
}

/* ================= WS BTC ================= */
let ws;
function connect(){
  if(ws) ws.close();
  ws=new WebSocket("wss://stream.binance.com:9443/stream?streams="+TF.map(t=>"btcusdt@kline_"+t).join("/"));
  ws.onmessage=e=>{
    const k=JSON.parse(e.data).data.k;
    if(!k.x) return;
    const p=S.BTCUSDT;
    const d=p.tf[k.i];
    p.prevPrice=p.price;
    d.tf=k.i; d.prev=d.last; d.last=+k.c; p.price=+k.c;
    createMission(d); updateMission(d,+k.c);
    updateAnchor(p); updateContext(p);
    save(); render();
  };
}
connect();
setInterval(()=>{if(!ws||ws.readyState>1)connect()},5000);

/* ================= XAU LOOP ================= */
setInterval(()=>{
  const p=S.XAUUSD;
  if(!p.anchor) return;
  p.prevPrice=p.price;
  p.price=p.anchor.C;
  TF.forEach(tf=>{
    const d=p.tf[tf];
    d.tf=tf; d.prev=d.last; d.last=p.anchor.C;
    createMission(d); updateMission(d,p.anchor.C);
  });
  updateAnchor(p); updateContext(p);
  save(); render();
},60000);

/* ================= UI HELPERS (ITEM 51 FIX) ================= */
function setActiveButton(btn){
  [buy,sell].forEach(b=>b.classList.remove("ui-active"));
  if(btn) btn.classList.add("ui-active");
}

/* ================= DECIDE ================= */
function decide(dir){
  const p=S[pair.value];
  updateAnchor(p);

  const cs=contextStrength(p);
  if(cs.score<40){
    status.textContent="WAIT · CONTEXT WEAK";
    lateWarn.classList.remove("hidden");
    return;
  }

  const ds=getDecisionState(p);
  if(ds!=="GAS"){
    status.textContent=ds;
    return;
  }

  status.textContent="GAS "+dir;
  const m1=p.tf["1m"].missions[0];
  const m5=p.tf["5m"].missions[0];
  if(m1&&m5){
    const lo=Math.min(m1.price,m5.price);
    const hi=Math.max(m1.price,m5.price);
    entryZone.textContent=`ENTRY IDEAL: M1–M5 (${lo.toFixed(2)} – ${hi.toFixed(2)})`;
    entryZone.classList.remove("hidden");
  }

  tpSuggestEl.textContent=tpSuggest(p);
  p.cooldownUntil=Date.now()+60000;
  gasSound();
  save(); render();
}

/* ================= SOUND ================= */
const AC=new (window.AudioContext||window.webkitAudioContext)();
function gasSound(){
  let i=0,t=setInterval(()=>{
    const o=AC.createOscillator(),g=AC.createGain();
    o.frequency.value=1000; g.gain.value=.08;
    o.connect(g); g.connect(AC.destination);
    o.start(); o.stop(AC.currentTime+.12);
    if(++i===4) clearInterval(t);
  },180);
}

/* ================= RENDER ================= */
const pair=document.getElementById("pair");
const status=document.getElementById("status");
const session=document.getElementById("session");
const contextLabel=document.getElementById("contextLabel");
const missionView=document.getElementById("missionView");
const strengthEl=document.getElementById("strength");
const priorityTarget=document.getElementById("priorityTarget");
const entryZone=document.getElementById("entryZone");
const tpSuggestEl=document.getElementById("tpSuggest");
const lateWarn=document.getElementById("lateWarn");
const cooldown=document.getElementById("cooldown");
const reason=document.getElementById("reason");
const lines=document.getElementById("lines");
const buy=document.getElementById("buy");
const sell=document.getElementById("sell");
const anchorNote=document.getElementById("anchorNote");

function render(){
  const p=S[pair.value];
  session.textContent="SESSION: "+getSession();

  const ds=getDecisionState(p);
  [buy,sell].forEach(btn=>{
    btn.textContent=btn.id.toUpperCase()+" · "+ds;
  });

  if(ds==="LATE") lateWarn.classList.remove("hidden");
  else lateWarn.classList.add("hidden");

  if(p.contextState==="CONTEXT_FRESH"){contextLabel.textContent="CONTEXT BARU";contextLabel.style.color="#00ff99";}
  else if(p.contextState==="CONTEXT_VALID"){contextLabel.textContent="CONTEXT UTUH";contextLabel.style.color="#00ffff";}
  else if(p.contextState==="CONTEXT_BREACHED"){contextLabel.textContent="STRUCTURE BREAK";contextLabel.style.color="#ff4444";}
  else{contextLabel.textContent="CONTEXT NONE";contextLabel.style.color="#666";}

  let txt="";
  TF.forEach(tf=>{
    p.tf[tf].missions.slice(-2).forEach(m=>{
      txt+=`${tf} ${m.price.toFixed(2)} ${m.status}\n`;
    });
  });
  missionView.textContent=txt.trim();

  const cs=contextStrength(p);
  strengthEl.textContent=`STRENGTH: ${cs.score}/100 (${cs.cat})`;
  priorityTarget.textContent=p.contextState==="CONTEXT_BREACHED"?"TARGET BERIKUTNYA: LEVEL TERDEKAT":"";
  cooldown.classList.toggle("hidden",!inCooldown(p));

  lines.innerHTML="";
  ["15m","30m","1h"].forEach(tf=>{
    p.tf[tf].missions.forEach(m=>{
      if(m.role==="CONTEXT"&&m.status==="CONTEXT"){
        const line=document.createElement("div");
        line.className="line "+(tf==="15m"?"m15":tf==="30m"?"m30":"h1");
        const y=(1-(m.price/(p.price||m.price)))*200;
        line.style.top=Math.max(0,Math.min(200,y))+"px";
        lines.appendChild(line);
      }
    });
  });
}

/* ================= EVENTS ================= */
document.getElementById("setAnchor").onclick=()=>{
  const O=+o.value,H=+h.value,L=+l.value,C=+c.value;
  const p=S[pair.value];
  if(H<Math.max(O,C)||L>Math.min(O,C)||O===C) p.anchor={bad:true,t:Date.now()};
  else p.anchor={O,H,L,C,t:Date.now()};
  updateAnchor(p); save(); render();

  /* ITEM 52 FIX */
  if(p.anchorState==="OK"){
    anchorNote.innerHTML="✅ ANCHOR OK · H1 LOCKED<br>⏱️ "+new Date().toUTCString();
    anchorNote.className="ok";
  }else{
    anchorNote.innerHTML="⚠️ ANCHOR "+p.anchorState+" · ENTRY DIBLOK";
    anchorNote.className="warn";
  }
};

buy.onclick=()=>{setActiveButton(buy);decide("BUY");};
sell.onclick=()=>{setActiveButton(sell);decide("SELL");};
toggleReason.onclick=()=>{
  reason.classList.toggle("hidden");
  toggleReason.classList.toggle("ui-active",!reason.classList.contains("hidden"));
};

function loadChart(){
  const sym=pair.value==="BTCUSDT"?"BINANCE:BTCUSDT":"OANDA:XAUUSD";
  tv.src=`https://s.tradingview.com/widgetembed/?symbol=${sym}&interval=60&theme=dark&timezone=Etc/UTC`;
}
pair.onchange=()=>{loadChart();render();};
loadChart(); render();
</script>
</body>
</html>
